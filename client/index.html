<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Yam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />
  <style>
    :root { --bg:#0b0b0b; --fg:#eaeaea; --muted:#999; --me:#2b6cb0; --other:#2d2d2d; --bubble-me:#1f6feb; --bubble-other:#202124; }
    html, body { margin:0; padding:0; width:100%; height:100dvh; overflow:hidden; background:var(--bg); color:var(--fg); }
    #app { height:100dvh; display:flex; flex-direction:column; }

    header{
      position: sticky; top: 0; z-index: 50;
      background:#111; padding-top: max(12px, env(safe-area-inset-top));
      border-bottom: 1px solid #222; display:flex; align-items:center; justify-content:space-between;
    }
    .hdr-left{ display:flex; flex-direction:column; }
    .icon-btn{ background:transparent; border:0; padding:8px; border-radius:10px; color:#ccc; }
    .icon-btn:active{ transform:scale(0.98); }
    header h1 { margin:0; font-size:16px; }
    #status { color:var(--muted); margin-top:4px; }
    .version { color: var(--muted); margin-left: 6px; font-weight: 400; }

    main{
      min-height: 0; overflow: hidden; flex:1;
      display:grid; grid-template-rows: 1fr auto; /* messages grows; composer fixed */
    }
    .messages{
      min-height:0; -webkit-overflow-scrolling: touch; overflow:auto;
      padding:12px 12px 4px; display:flex; flex-direction:column; gap:8px;
    }
    .row { display:flex; width:100%; }
    .row .wrap{ max-width:75%; display:flex; flex-direction:column; }
    .name-label{ font-size:11px; color:#bbb; margin:2px 8px 4px; }
    .bubble { max-width:100%; padding:10px 12px; border-radius:16px; line-height:1.25; position:relative; word-wrap:break-word; }
    .me   { justify-content:flex-end; }
    .me .bubble { background:var(--bubble-me); color:white; border-top-right-radius:6px; }
    .other { justify-content:flex-start; }
    .other .bubble { background:var(--bubble-other); color:#eaeaea; border-top-left-radius:6px; }
    .bubble img { max-width: 68vw; height: auto; display:block; border-radius:12px; }
    .file-link { color:#cdd; text-decoration: underline; word-break: break-all; }

    .composer{
      display:grid; grid-template-columns: auto 1fr auto; gap:8px;
      background:#0b0b0b; padding:12px 16px; border-top:1px solid #222;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    .composer input, .composer button {
      padding:12px; border-radius:12px; border:1px solid #333; background:#151515; color:#eaeaea;
    }
    .attach-btn { display:flex; align-items:center; justify-content:center; width:44px; }
    .attach-btn svg { display:block; }

    footer { padding:8px 16px; font-size:12px; color:#999; border-top:1px solid #222; }
    .keyhint { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#a7b; overflow-wrap:anywhere; }

    /* Dialog */
    dialog{ position:relative; border:1px solid #333; border-radius:14px; padding:16px; background:#121212; color:#eaeaea; width:min(560px,94vw); }
    dialog::backdrop{ background:rgba(0,0,0,.6); }
    .dialog-close{ position:absolute; top:8px; right:10px; background:transparent; border:0; color:#aaa; font-size:22px; line-height:1; cursor:pointer; }

    .settings-stack{ display:flex; flex-direction:column; gap:14px; }
    .field label{ display:block; font-size:12px; color:#bbb; margin:0 0 6px; }
    .field input{ width:100%; padding:12px; border-radius:12px; border:1px solid #333; background:#151515; color:#eaeaea; }
    .row-buttons{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
    .row-buttons button, .settings-actions button{
      padding:12px; border-radius:12px; border:1px solid #333; background:#1a1a1a; color:#eaeaea;
    }
    .row-buttons button:active, .settings-actions button:active{ transform:scale(0.98); }
    .help{ margin:6px 0 0; }
    .settings-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }

    .pending { display:flex; align-items:center; gap:8px; opacity:0.9; }
    .retry-btn {
      display:inline-flex; align-items:center; justify-content:center;
      width:28px; height:28px; border-radius:50%;
      border:1px solid #333; background:#1a1a1a; color:#eaeaea; cursor:pointer;
    }
    .retry-btn:active { transform:scale(0.96); }
    .retry-icon { width:16px; height:16px; display:block; }

    .hdr-center{ position: absolute; left:50%; transform:translateX(-50%); display:flex; align-items:center; }
    .room-button{
      display:flex; align-items:center; gap:6px; background:transparent; border:1px solid #333; color:#eaeaea;
      border-radius:12px; padding:6px 10px; cursor:pointer;
    }
    .room-button .chev{ opacity:.7; }
    .room-menu{
      position:absolute; top:calc(100% + 8px); left:50%; transform:translateX(-50%);
      min-width:220px; background:#121212; border:1px solid #333; border-radius:12px; padding:6px; z-index:60;
      box-shadow: 0 8px 24px rgba(0,0,0,.4);
    }
    .room-item{ display:flex; justify-content:space-between; gap:8px; padding:8px 10px; border-radius:10px; cursor:pointer; }
    .room-item:hover{ background:#1a1a1a; }
    .room-item .sub{ font-size:11px; color:#aaa; }
    .room-create{ margin-top:6px; padding:8px 10px; border-top:1px solid #222; cursor:pointer; color:#cde; }
    .room-create:hover{ background:#161616; }
    
  </style>
</head>
<body>
  
  <!-- Settings dialog -->
  <dialog id="settingsModal">
    <button id="btnCloseSettings" class="dialog-close" aria-label="Close">×</button>
    <form method="dialog">
      <h3 style="margin:0 0 10px">Configure room</h3>
      <div class="settings-stack">
	<div class="field">
	  <label for="cfgRoomName">Room name</label>
	  <input id="cfgRoomName" placeholder="Room name" />
	</div>
      </div>
      <div class="settings-actions" style="justify-content:space-between">
	<button type="button" id="btnRemoveRoom" style="border-color:#7a1a1a;background:#2a0e0e;color:#ffb3b3">Remove room</button>
	<div>
	  <button type="button" id="btnSaveRoomCfg">Save</button>
	  <button type="button" id="btnInvite">Invite</button>
	</div>
      </div>
    </form>
  </dialog>
  
  <!-- Create room dialog -->  
  <dialog id="createRoomModal">
    <button id="btnCloseCreateRoom" class="dialog-close" aria-label="Close">×</button>
    <form method="dialog">
      <h3 style="margin:0 0 10px">Create new room</h3>
      <div class="settings-stack">
	<div class="field">
	  <label for="newRoomName">Room name</label>
	  <input id="newRoomName" placeholder="e.g., Family chat" />
	</div>
	<div class="field">
	  <label for="newServerUrl">Server URL</label>
	  <input id="newServerUrl" placeholder="https://rartino.pythonanywhere.com" />
	  <p class="muted help">Use the base URL of your relay server (no trailing slash).</p>
	</div>
      </div>
      <div class="settings-actions">
	<button type="button" id="btnCreateRoom">Create room</button>
      </div>
    </form>
  </dialog>
  
  <!-- Invite (sender) -->
  <dialog id="inviteModal">
    <button id="btnCloseInvite" class="dialog-close" aria-label="Close">×</button>
    <form method="dialog">
      <h3 style="margin:0 0 10px">Invite to this room</h3>
      <div class="settings-stack">
	<p class="muted help">Step 1: Copy this invitation code and send it to your friend.</p>
	<div class="field">
	  <label>Invitation code</label>
	  <textarea id="inviteOffer" readonly rows="5" style="width:100%;padding:10px;border-radius:12px;border:1px solid #333;background:#151515;color:#eaeaea;"></textarea>
	  <div class="row-buttons" style="grid-template-columns:auto auto">
	    <button type="button" id="btnCopyInviteOffer">Copy</button>
	    <button type="button" id="btnRefreshInviteOffer">Regenerate</button>
	  </div>
	</div>

	<p class="muted help">Step 2: Paste the response code you get back and finish.</p>
	<div class="field">
	  <label>Response code</label>
	  <textarea id="inviteAnswer" rows="5" placeholder="Paste response code here" style="width:100%;padding:10px;border-radius:12px;border:1px solid #333;background:#151515;color:#eaeaea;"></textarea>
	</div>
      </div>
      <div class="settings-actions" style="justify-content:flex-end">
	<button type="button" id="btnFinishInvite">Finish</button>
      </div>
    </form>
  </dialog>

  <!-- Join (receiver) -->
  <dialog id="joinModal">
    <button id="btnCloseJoin" class="dialog-close" aria-label="Close">×</button>
    <form method="dialog">
      <h3 style="margin:0 0 10px">Join a room</h3>
      <div class="settings-stack">
	<p class="muted help">Step 1: Paste the invitation code you received.</p>
	<div class="field">
	  <label>Invitation code</label>
	  <textarea id="joinOffer" spellcheck="false" rows="5" placeholder="Paste invitation code here" style="width:100%;padding:10px;border-radius:12px;border:1px solid #333;background:#151515;color:#eaeaea;"></textarea>
	</div>

	<p class="muted help">Step 2: Copy the response code below and send it back.</p>
	<div class="field">
	  <label>Response code</label>
	  <textarea id="joinAnswer" spellcheck="false" readonly rows="5" style="width:100%;padding:10px;border-radius:12px;border:1px solid #333;background:#151515;color:#eaeaea;"></textarea>
	  <div class="row-buttons" style="grid-template-columns:auto auto">
	    <button type="button" id="btnMakeJoinAnswer">Generate response</button>
	    <button type="button" id="btnCopyJoinAnswer">Copy</button>
	  </div>
	</div>
      </div>
    </form>
  </dialog>
  
  <div id="app">
    <header>
      <div class="hdr-left">
        <h1>Yam<span id="appVersion" class="version"></span></h1>
        <div id="status">Not connected</div>
      </div>
      <div class="hdr-center">
	<button id="btnRoomMenu" class="room-button" aria-haspopup="true" aria-expanded="false">
	  <span id="currentRoomName">No room</span>
	  <svg class="chev" viewBox="0 0 24 24" width="16" height="16" fill="currentColor" aria-hidden="true">
	    <path d="M7 10l5 5 5-5z"/>
	  </svg>
	</button>
	<div id="roomMenu" class="room-menu" hidden></div>
      </div>
      <button id="btnSettings" class="icon-btn" aria-label="Settings" title="Settings">
        <!-- gear icon -->
        <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 8.5a3.5 3.5 0 1 0 0 7 3.5 3.5 0 0 0 0-7Zm8.94 3.24-.97-.56a7.96 7.96 0 0 0-.26-1l.73-.89a.7.7 0 0 0-.08-.98l-1.1-1.1a.7.7 0 0 0-.98-.08l-.89.73c-.32-.12-.66-.21-1-.26l-.56-.97a.7.7 0 0 0-.62-.36h-1.56a.7.7 0 0 0-.62.36l-.56.97c-.34.05-.68.14-1 .26l-.89-.73a.7.7 0 0 0-.98.08l-1.1 1.1a.7.7 0 0 0-.08.98l.73.89c-.12.32-.21.66-.26 1l-.97.56a.7.7 0 0 0-.36.62v1.56c0 .26.14.5.36.62l.97.56c.05.34.14.68.26 1l-.73.89a.7.7 0 0 0 .08.98l1.1 1.1c.25.25.64.27.92.08l.89-.73c.32.12.66.21 1 .26l.56.97c.12.22.36.36.62.36h1.56c.26 0 .5-.14.62-.36l.56-.97c.34-.05.68-.14 1-.26l.89.73c.28.2.67.17.92-.08l1.1-1.1c.25-.25.27-.64.08-.92l-.73-.89c.12-.32.21-.66.26-1l.97-.56c.22-.12.36-.36.36-.62v-1.56a.7.7 0 0 0-.36-.62Z"/>
        </svg>
      </button>
    </header>

    <main>
      <div id="messages" class="messages"></div>

      <div class="composer">
        <button id="btnAttach" class="attach-btn" title="Attach">
          <!-- paperclip -->
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M16.5,6.5 L8.5,14.5 C7.1,15.9 7.1,18.1 8.5,19.5 C9.9,20.9 12.1,20.9 13.5,19.5 L19,14 C21,12 21,8.9 19,6.9 C17,4.9 13.9,4.9 11.9,6.9 L6,12.8"/>
          </svg>
        </button>
        <input id="messageInput" placeholder="Type a message…" />
        <button id="btnSend">Send</button>
        <input id="fileInput" type="file" style="display:none" />
      </div>
    </main>

    <footer>
      Installable PWA. E2E via sealed boxes. Identity bubbles are based on a device key stored locally.
      <div id="identityInfo" class="keyhint"></div>
    </footer>
  </div>

  <script src="vendor/sodium/sodium.js"></script>

  <script type="module">
    fetch('./manifest.json')
      .then(r => r.json())
      .then(manifest => {
        window.APP_VERSION = manifest.version;
        const vEl = document.getElementById('appVersion');
        if (vEl) vEl.textContent = `v${window.APP_VERSION}`;
        const script = document.createElement('script');
        script.type = 'module';
        script.src = `./messenger.js?v=${window.APP_VERSION}`;
        document.body.appendChild(script);
      })
      .catch(err => console.error('Failed to load manifest:', err));
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => console.log('Service Worker Registered'));
    }
  </script>
</body>
</html>
